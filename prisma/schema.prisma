// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("SBULLASY_APP_DB_URL")
}

model User {
  id                    String            @id
  email                 String            @unique
  name                  String            @unique
  displayName           String
  createdAt             Int
  ipRegisteredFrom      String
  registrationExpiresAt Int
  verificationExpiresAt Int
  belongsTo             Membership[]      @relation(name: "groupMember")
  tokens                Token[]           @relation(name: "tokenOwner")
  requests              RequestFromUser[] @relation(name: "requestRequestedFrom")

  @@index(fields: [id])
  @@index(fields: [email])
  @@map("users")
}

model Group {
  id             String       @id
  name           String       @unique
  displayName    String
  createdAt      Int
  isAdmin        Boolean
  invitationCode String
  members        Membership[] @relation(name: "userBelongsTo")
  permissions    Permission[] @relation(name: "permissionGrantsTo")
  items          Item[]       @relation(name: "itemOwner")

  @@index(fields: [id])
  @@index(fields: [name])
  @@map("groups")
}

model Membership {
  userId  String
  user    User           @relation(name: "groupMember", fields: [userId], references: [id], onDelete: Cascade)
  groupId String
  group   Group          @relation(name: "userBelongsTo", fields: [groupId], references: [id], onDelete: Cascade)
  type    MembershipType

  @@id(fields: [userId, groupId])
  @@index(fields: [userId])
  @@index(fields: [groupId])
  @@map("memberships")
}

model Token {
  id           String      @id
  secret       String      @unique
  type         TokenType
  expiresAt    Int
  ownerId      String
  owner        User        @relation(name: "tokenOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  permissionId String?
  permission   Permission? @relation(name: "tokenPermission", fields: [permissionId], references: [id], onDelete: Cascade)

  @@index(fields: [id])
  @@index(fields: [type, secret])
  @@map("tokens")
}

model RequestFromUser {
  id              String      @id
  secret          String      @unique
  email           String?
  expiresAt       Int
  type            RequestType
  requestedFromId String
  requestedFrom   User        @relation(name: "requestRequestedFrom", fields: [requestedFromId], references: [id], onDelete: Cascade)

  @@index(fields: [id])
  @@map("requestsFromUser")
}

model Permission {
  id           String         @id
  type         PermissionType
  expiresAt    Int
  tokens       Token[]        @relation(name: "tokenPermission")
  grantsToId   String
  grantsTo     Group          @relation(name: "permissionGrantsTo", fields: [grantsToId], references: [id], onDelete: Cascade)
  targetTypeId String
  targetType   Item           @relation(name: "permissionTargetType", fields: [targetTypeId], references: [id], onDelete: Cascade)

  @@index(fields: [grantsToId, targetTypeId])
  @@map("permissions")
}

model Item {
  id                    String       @id
  name                  String
  createdAt             Int
  updatedAt             Int
  isPublic              Boolean
  ownerId               String?
  owner                 Group?       @relation(name: "itemOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  typeId                String?
  type                  Item?        @relation(name: "itemType", fields: [typeId], references: [id], onDelete: Restrict)
  attributes            Attribute[]  @relation(name: "itemParent")
  referrers             Attribute[]  @relation(name: "itemValue")
  instances             Item[]       @relation(name: "itemType")
  attributesOfInstances Attribute[]  @relation(name: "itemParentItemType")
  accessibleFrom        Permission[] @relation(name: "permissionTargetType")

  @@index(fields: [typeId, id])
  @@map("items")
}

model Attribute {
  id               String   @id
  parentId         String
  parent           Item     @relation(name: "itemParent", fields: [parentId], references: [id], onDelete: Cascade)
  parentItemTypeId String
  parentItemType   Item     @relation(name: "itemParentItemType", references: [id], fields: [parentItemTypeId], onDelete: Restrict)
  key              String
  valueString      String?
  valueNumber      Float?
  valueBoolean     Boolean?
  valueItemId      String?
  valueItem        Item?    @relation(name: "itemValue", fields: [valueItemId], references: [id], onDelete: SetNull)
  showOnSummary    Boolean

  @@index(fields: [parentItemTypeId, parentId])
  @@index(fields: [parentItemTypeId, key, valueString])
  @@index(fields: [parentItemTypeId, key, valueNumber])
  @@index(fields: [parentItemTypeId, key, valueBoolean])
  @@map("attributes")
}

enum MembershipType {
  admin
  member
}

enum TokenType {
  cookie
  bearer
}

enum RequestType {
  token
  verification
}

enum PermissionType {
  read
  write
}
